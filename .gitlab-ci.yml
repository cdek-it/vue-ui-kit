variables:
  DOCKER_IMAGE: 'node:16'

stages:
  - lint
  - publish
  - storybook

.common:
  image: ${DOCKER_IMAGE}

  cache:
    key: vue-ui-kit-vendor
    paths:
      - node_modules/

  tags:
    - docker

yarn:
  stage: .pre
  extends: .common

  script:
    - yarn install

  cache:
    policy: push

lint:
  stage: lint
  extends: .common
  except:
    - main
  script:
    - yarn run lint:cli

  cache:
    policy: pull

# test:
#   stage: lint
#   extends: .common
#   except:
#     - main
#   script:
#     - yarn run test:cli

#   cache:
#     policy: pull

type-check:
  stage: lint
  extends: .common
  except:
    - main
  script:
    - yarn run type-check

  cache:
    policy: pull

publish:
  stage: publish
  extends: .common
  only:
    - main
    - /^release\/.*/
  when: manual

  script:
    - yarn build
    - echo -e "@cdek-ui-kit:registry=https://gitlab.cdek.ru/api/v4/projects/2094/packages/npm/\n//gitlab.cdek.ru/api/v4/projects/2094/packages/npm/:_authToken=${GITLAB_AUTH_TOKEN}">.npmrc
    - npm publish

  cache:
    policy: pull

publish-with-prefix:
  stage: publish
  extends: .common
  only:
    - main
    - /^release\/.*/
  when: manual

  script:
    - yarn build-with-prefix
    - echo -e "@cdek-ui-kit:registry=https://gitlab.cdek.ru/api/v4/projects/2094/packages/npm/\n//gitlab.cdek.ru/api/v4/projects/2094/packages/npm/:_authToken=${GITLAB_AUTH_TOKEN}">.npmrc
    - npm publish

  cache:
    policy: pull

pages:
  stage: storybook
  extends: .common
  script:
    - yarn build-storybook -o public
  artifacts:
    paths:
      - public
  only:
    - main
  when: manual

  cache:
    paths:
      - public/
