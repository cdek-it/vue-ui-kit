import { Meta, Story } from '@storybook/blocks';
import * as BaseFormStories from '../BaseForm.stories.js';
import * as BaseFormControlStories from '../../base-form-control/BaseFormControl.stories.js';

<Meta title="Form/CdekForm/GlobalValidators" />

# Глобальные валидаторы

> В стадии разработки

На данный момент доступны следующие валидаторы:

- `alpha` - в поле можно ввести только буквы (смотрит на текущую локаль)
- `required` - поле обязательное
- `email` - проверка на валидный email
- `regex` - проверка по паттерну (смотри подробнее ниже)

Например, чтобы поле могло принимать только буквы, надо написать:

```html dark
<CdekFormControl name="firstName" rules="alpha" />
```

> Попробуйте ввести цифры в поле `firstName`

<Story of={BaseFormStories.GlobalValidator} />

А чтобы поле было обязательным и проверялось на email, надо написать:

```html dark
<CdekFormControl name="email" rules="required|email" />
```

> Начните вводить `email`

> Очистите поле

<Story of={BaseFormControlStories.RequiredWithEmail} />

---

### Regex

Правило `regex` можно передать только в форме объекта.

```js dark
const rules = {
  regex: /^([0-9]+)$/,
};
```

```html dark
<CdekFormControl :rules="rules"></CdekFormControl>
```

> Попробуйте ввести НЕ цифры

<Story of={BaseFormControlStories.Regex} />

Если хочется использовать `regex` с другими глобальными валидаторами, нужно
добавить в объект `rules` ключ с названием валидатора со значением `true`.

```js dark
const rules = {
  required: true,
  regex: /^([0-9]+)$/,
};
```

> Попробуйте ввести значение и стереть

<Story of={BaseFormControlStories.RegexWithRequired} />

Если необходимо локально изменить сообщение об ошибке для правила `regex`, то настройку нужно
передать объектом

```js dark
const rules = {
  regex: {
    pattern: /^([0-9]+)$/,
    message: 'Только цифры',
  },
};
```

`message` можно передать как строкой, так и функцией. Подробнее о настройке сообщения можно
прочитать ниже в блоке "Кастомное сообщение об ошибке".

> Попробуйте ввести НЕ цифры

<Story of={BaseFormControlStories.RegexWithCustomError} />

---

### Переводы

Изначально валидаторы поставляются с сообщениями только на русском языке. Однако библиотека
предоставляет сервисные функции, чтобы добавить/изменить сообщения на других локалях.

Например, чтобы добавить перевод к валидатору `required` на английском нужно написать:

```js dark
import { formSettings } from '@cdek-ui-kit/vue';

formSettings.addMessages('required', {
  en: 'Required field',
});
```

Первый параметр - название валидатора, второй параметр - объект по типу:

```js dark
{
  <код локали>: string;
}
```

Таким же образом можно заменить сообщение на `ru` локали, просто передав сообщение на `ru`:

```js dark
formSettings.addMessages('required', {
  ru: 'Другое сообщение на русском',
});
```

В валидаторах есть дефолтная локаль, если требуется сообщение на `zh` локали, а такой нет, то покажется
сообщение дефолтной локали. По стандарту показывается `ru`.

Если необходимо сменить дефолтную локаль, то нужно:

```js dark
formSettings.changeDefaultLocale('en');
```

Для смены языка сообщений при смене текущего языка на странице, нужно:

```js dark
formSettings.changeLocale(<код локали>);
```

Если подключен **i18n**, можно использовать такую функцию:

```js dark
export const checkLocaleForForm = () => {
  const { locale } = useI18n();

  watch(locale, (newLocale) => {
    formSettings.changeLocale(newLocale);
  });
};
```

Эту функцию нужно вызвать при инициализации приложения на клиенте.

> Попробуйте нажать "Продолжить" с пустым значение `firstName`, а далее переключить язык

<Story of={BaseFormStories.ChangeLanguage} />

---

### Кастомное сообщение об ошибке

Есть возможность локально переопределить сообщение об ошибке (глобально это не будет распространяться).
При передаче глобальных валидаторов в виде объекта, можно передать не только `true`, но и строку,
которая и будет являться новым сообщением.

```js dark
const rules = {
  required: 'Я - кастомное сообщение об ошибке',
};
```

> Введите и уберите текст, чтобы увидеть кастомное сообщение

<Story of={BaseFormControlStories.RequiredCustomMessage} />

Если же вам необходимо вычислить сообщение об ошибке или например получить перевод, то
вы можете передать не строку, а функцию.

```js dark
const rules = {
  required: () => '',
};
```

> Введите и уберите текст несколько раз, вы заметите что оно меняется

<Story of={BaseFormControlStories.RequiredCustomMessageFunction} />

Будьте внимательны с названиями кастомных валидаторов, они не должны совпадать с заданными
глобальными валидаторами.
